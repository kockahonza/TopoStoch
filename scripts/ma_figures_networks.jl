using Revise
using NonEqDigits

using CairoMakie
using GLMakie
using JLD2
using Geppetto

includet("ma_colors.jl")
includet("ned_ca_s1_stats.jl")
includet("ma_graphviz.jl")

single_col_width = 324 # corresponds to 3+3/8 in as state in PR guidelines
double_col_width = single_col_width * 2
golden_ratio = 1.618

fig_kwargs = (;
    fontsize=8,
    figure_padding=0.0
)
other_kwargs = (;
    node_size=4.0,
    edge_width=0.5,
    arrow_size=6.0,
)

function get_ac_coloring_extra_kwargs(g)
    acs = attracting_components(g)
    ac_classes = ac_eq_class.(Ref(g), acs)

    node_color = [MAColors.gray1() for _ in 1:nv(g)]
    for (ac, class) in zip(acs, ac_classes)
        for v in ac
            if class == :single
                node_color[v] = MAColors.ac_ss()
            elseif class == :eq
                node_color[v] = MAColors.ac_nss_eq()
            elseif class == :neq
                node_color[v] = MAColors.ac_nss_neq()
            end
        end
    end

    edge_color = [node_color[e.src] for e in edges(g)]

    (; e_color=false, node_color, edge_color)
end

function f2_r124_v1(; kwargs...)
    # some saved/hardcoded positions to use
    pp1 = Point{2,Float32}[[3.0, 3.0], [1.3281027, 7.801583], [8.788723, 2.4386742], [1.8143778, 7.417807], [0.9566255, 3.6729279], [2.4552433, 6.4659653], [8.283378, 2.8011382], [2.4852808, 6.883159], [6.147224, 9.510905], [4.2407727, 7.2257137], [7.427527, 3.7925913], [3.9467535, 6.7221065], [1.5572437, 3.8586738], [2.966725, 6.0116615], [7.585234, 3.3046503], [3.342512, 6.3276653], [3.945704, 0.62469023], [4.041539, 2.5424602], [5.8668523, 2.7930262], [4.130808, 3.308027], [2.5206087, 3.803837], [3.6487694, 4.712955], [6.1536965, 3.302475], [4.117363, 4.3492246], [6.008791, 8.908372], [4.784686, 7.020344], [6.853893, 4.3067975], [4.564082, 6.3090115], [2.3925226, 4.11248], [3.5494123, 5.3562384], [6.720627, 3.76296], [4.106907, 5.4935226], [9.115075, 6.567199], [8.527446, 6.3390207], [7.7925787, 5.6941795], [7.7078905, 6.0132933], [5.0220795, 5.0884323], [5.7609415, 5.2533126], [7.173354, 5.5075984], [6.6926003, 5.6359873], [6.110993, 7.773186], [5.9986854, 7.1002054], [6.3149033, 5.6771326], [5.9652653, 6.226559], [4.395176, 4.7655463], [4.9200416, 5.722167], [6.4562545, 5.2027903], [5.813485, 5.4821115], [4.0718455, 1.2303998], [4.2473364, 2.066916], [5.312384, 2.9888923], [4.5840364, 2.9728065], [3.1116984, 4.0472164], [3.8456006, 4.2576814], [5.5302587, 3.6746464], [4.664177, 3.981581], [5.8204093, 8.069906], [5.503597, 7.097015], [6.179469, 5.098191], [5.4311023, 5.9643598], [3.4126747, 4.4565], [4.1496544, 4.882143], [5.9767957, 4.469583], [5.2476373, 4.422474]]

    ss = double_col_width / 2

    ma = MolAut(6, 124; reduced=false)
    faa = plotgm(ma;
        layout=pp1,
        flabels=false,
        get_ac_coloring_extra_kwargs(ma.mg)...,
        # nlabels=["000000"; fill("", 62); "111111"],
        # nlabels_align=(:center, :top),
        # nlabels_offset=Point2f(0.0, -0.05),
        figure=(;
            size=(200, 200),
            fig_kwargs...
        ),
        other_kwargs...,
        kwargs...
    )

    hidedecorations!(faa.axis)
    # hidespines!(faa.axis)

    faa.axis.title = "Rule 124"

    save("./data/figures/fig2/r124_final.pdf", faa.figure)

    faa
end

function f2_r142_v1(; kwargs...)
    # some saved/hardcoded positions to use
    pp1 = Point{2,Float32}[[0.9534411, -2.5038016], [0.59584093, -3.9095232], [0.17095925, -3.8032608], [0.40841606, -3.772475], [-0.2644334, -4.0696282], [-0.7896743, -1.178741], [-0.04176763, -3.8707201], [0.18871951, -3.6994324], [-0.12653562, -4.56081], [-0.56409085, -1.6818004], [-0.023905873, -1.8806934], [-0.30590898, -1.7867441], [-0.19838633, -4.3000517], [-0.73771966, -1.4791207], [-0.12667106, -4.0360994], [-0.031074021, -3.757724], [0.40003258, -4.6377816], [-0.17447847, -1.8818226], [0.23421696, -1.4959354], [0.041789383, -1.6775165], [0.16320035, -0.9260697], [0.8454891, -2.8582444], [0.20679337, -1.2218099], [0.14329359, -1.447856], [0.1569122, -4.5807614], [-0.41196775, -1.8441463], [0.16862643, -1.7290664], [-0.114933014, -1.7968268], [0.006272954, -4.4205093], [-0.6872183, -1.7501893], [-0.112264484, -4.234797], [-0.19575872, -3.9521077], [0.80941314, -4.3292994], [0.7402337, -4.0661936], [0.26649374, -1.1076274], [0.64595395, -3.8159833], [-0.29446185, -0.95322317], [-0.55860937, -0.9952068], [-0.022395432, -1.0221043], [0.45722497, -3.6276524], [-0.6913165, -1.2382712], [-0.62224627, -1.4582634], [0.6129771, -2.6541712], [-0.4807415, -1.6356587], [-0.48146188, -1.0970969], [-0.62066877, -1.2446408], [-0.25106055, -1.0372868], [0.18442686, -3.564314], [0.62031364, -4.46002], [0.76193213, -4.2402124], [0.3301616, -1.2924347], [0.8343458, -3.976295], [-0.07149768, -0.8757424], [-0.34913814, -0.80281013], [0.14763302, -1.0583472], [0.7379994, -3.706066], [0.43787953, -4.516986], [0.713044, -4.4440646], [0.38461092, -1.5529914], [0.9218695, -4.2380505], [0.24218431, -4.542032], [0.528085, -4.6229944], [-0.0060266694, -4.495908], [0.7375371, -2.3426912]]
    pp2 = Point{2,Float32}[[-0.18817669, -3.3056338], [0.59584093, -3.9095232], [0.17095925, -3.8032608], [0.40841606, -3.772475], [-0.2644334, -4.0696282], [-0.38967428, -2.278741], [-0.04176763, -3.8707201], [0.18871951, -3.6994324], [-0.12653562, -4.56081], [-0.16409084, -2.7818003], [0.37609413, -2.9806933], [0.09409102, -2.886744], [-0.19838633, -4.3000517], [-0.33771965, -2.5791206], [-0.12667106, -4.0360994], [-0.031074021, -3.757724], [0.40003258, -4.6377816], [0.22552153, -2.9818225], [0.6342169, -2.5959353], [0.44178942, -2.7775164], [0.56320035, -2.0260696], [-0.16117068, -3.6083946], [0.60679334, -2.3218098], [0.5432936, -2.5478559], [0.1569122, -4.5807614], [-0.011967756, -2.9441462], [0.5686264, -2.8290663], [0.285067, -2.8968267], [0.006272954, -4.4205093], [-0.2872183, -2.8501892], [-0.112264484, -4.234797], [-0.19575872, -3.9521077], [0.80941314, -4.3292994], [0.7402337, -4.0661936], [0.6664937, -2.2076273], [0.64595395, -3.8159833], [0.10553815, -2.0532231], [-0.15860936, -2.0952067], [0.37760457, -2.1221042], [0.45722497, -3.6276524], [-0.29131648, -2.3382711], [-0.22224626, -2.5582633], [-0.28607348, -3.5781186], [-0.0807415, -2.7356586], [-0.081461884, -2.1970968], [-0.22066876, -2.3446407], [0.14893946, -2.1372867], [0.18442686, -3.564314], [0.62031364, -4.46002], [0.76193213, -4.2402124], [0.73016155, -2.3924346], [0.8343458, -3.976295], [0.32850233, -1.9757423], [0.050861858, -1.9028101], [0.547633, -2.1583471], [0.7379994, -3.706066], [0.43787953, -4.516986], [0.713044, -4.4440646], [0.78461087, -2.6529913], [0.9218695, -4.2380505], [0.24218431, -4.542032], [0.528085, -4.6229944], [-0.0060266694, -4.495908], [-0.35021278, -3.2753577]]
    pp3 = Point{2,Float32}[[0.44135505, -3.3278747], [0.38039595, -3.8100932], [0.12385982, -3.7165284], [0.29657722, -3.6949365], [-0.18488416, -3.9756312], [-0.20887516, -2.377832], [-0.023457961, -3.7525148], [0.098460205, -3.507807], [-0.12653562, -4.56081], [-0.20125528, -2.802472], [0.20767856, -3.2055206], [-0.023457961, -2.9248261], [-0.19838633, -4.3000517], [-0.26475433, -2.6009479], [-0.092036925, -3.9900255], [-0.046317615, -3.5437934], [0.25085792, -4.608993], [0.10354012, -3.2199152], [0.35499632, -2.96801], [0.25085792, -3.0039964], [0.31435695, -2.6081452], [0.35245636, -3.3062828], [0.34991643, -2.7664857], [0.30927703, -2.845656], [0.10354012, -4.5945983], [-0.056477465, -3.1263504], [0.37531602, -3.111956], [0.13909958, -2.946418], [0.032421198, -4.342693], [-0.21395509, -2.9104316], [-0.064097345, -4.2347336], [-0.16996501, -3.6956186], [0.41341546, -4.1339717], [0.42611527, -3.9828284], [0.311817, -2.3346481], [0.48199442, -3.702134], [0.019721389, -2.1835048], [-0.13013636, -2.161913], [0.17465906, -2.406621], [0.30927703, -3.435834], [-0.084417045, -2.5361724], [-0.152996, -2.6369345], [-0.21649505, -3.435834], [-0.10473674, -2.7880776], [-0.031077845, -2.3634372], [-0.13267632, -2.4929886], [0.0654407, -2.35624], [0.088300355, -3.3278747], [0.39309576, -4.2779174], [0.47437453, -4.1267743], [0.40833554, -2.773683], [0.59121275, -3.8820662], [0.20767856, -2.1331239], [0.03750112, -2.0755455], [0.41341546, -2.5865533], [0.5226338, -3.5725825], [0.25085792, -4.3570876], [0.49977416, -4.4506526], [0.41595542, -2.9608126], [0.59121275, -4.2635226], [0.14671947, -4.4002714], [0.4032556, -4.5658092], [-0.0060266694, -4.495908], [-0.14791608, -3.3998475]]

    pp4 = [Point2f(p[2], p[1]) for p in pp2]

    ma = MolAut(6, 142; reduced=false)
    faa = plotgm(ma;
        layout=pp4,
        flabels=false,
        get_ac_coloring_extra_kwargs(ma.mg)...,
        # nlabels=["000000"; fill("", 62); "111111"],
        # nlabels_align=(:center, :top),
        # nlabels_offset=Point2f(0.0, -0.05),
        # figure=(; size=(600, 600)),
        figure=(;
            # size=(120, 240),
            size=(260, 120),
            fig_kwargs...
        ),
        other_kwargs...,
        kwargs...
    )

    hidedecorations!(faa.axis)
    # hidespines!(faa.axis)

    faa.axis.title = "Rule 142"

    save("./data/figures/fig2/r142_final.pdf", faa.figure)

    faa
end

function f2_r170_v1(; kwargs...)
    ma = MolAut(6, 170; reduced=false)

    pos = get_gv_layout_positions(ma;
        cluster=true
    )

    faa = plotgm(ma;
        layout=pos,
        flabels=false,
        get_ac_coloring_extra_kwargs(ma.mg)...,
        # nlabels=["000000"; fill("", 62); "111111"],
        # nlabels_align=(:center, :top),
        # nlabels_offset=Point2f(0.0, -0.05),
        # figure=(; size=(600, 600)),
        figure=(;
            size=(250, 160),
            fig_kwargs...
        ),
        other_kwargs...,
        kwargs...
    )

    hidedecorations!(faa.axis)
    # hidespines!(faa.axis)

    faa.axis.title = "Rule 170"

    save("./data/figures/fig2/r170_final.pdf", faa.figure)

    faa
end

function make_plots()
    f2_r124_v1()
    f2_r142_v1()
    f2_r170_v1()
    nothing
end

function f2_r240_v1(; kwargs...)
    ma = MolAut(6, 240; reduced=false)

    pos = get_gv_layout_positions(ma;
        cluster=true
    )

    faa = plotgm(ma;
        layout=pos,
        flabels=false,
        get_ac_coloring_extra_kwargs(ma.mg)...,
        # nlabels=["000000"; fill("", 62); "111111"],
        # nlabels_align=(:center, :top),
        # nlabels_offset=Point2f(0.0, -0.05),
        # figure=(; size=(600, 600)),
        figure=(;
            size=(200, 130),
            fig_kwargs...
        ),
        other_kwargs...,
        kwargs...
    )

    hidedecorations!(faa.axis)
    # hidespines!(faa.axis)

    faa.axis.title = "Rule 240"

    save("./data/figures/fig2/r240_final.pdf", faa.figure)

    faa
end

